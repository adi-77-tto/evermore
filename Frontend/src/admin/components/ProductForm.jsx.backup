import React, { useState, useEffect } from "react"
import { getApiUrl } from '../../config/api'

export default function ProductForm({ mode = 'add', productId = null, onSuccess, onCancel }) {
  const sizes = ["XS", "S", "M", "L", "XL", "XXL", "XXXL"]
  
  const [loading, setLoading] = useState(false)
  const [error, setError] = useState('')
  const [success, setSuccess] = useState('')
  const [categories, setCategories] = useState([])
  
  const [formData, setFormData] = useState({
    name: "",
    category_slug: "",
    description: "",
    base_price: "",
    color: "",
    sizeQuantities: {},
    images: [],
    size_fit: "",
    care_maintenance: ""
  })

  // Predefined color options
  const colorOptions = [
    { name: "Black", value: "Black" },
    { name: "White", value: "White" },
    { name: "Gray", value: "Gray" },
    { name: "Brown", value: "Brown" },
    { name: "Beige", value: "Beige" },
    { name: "Navy", value: "Navy" },
    { name: "Blue", value: "Blue" },
    { name: "Red", value: "Red" },
    { name: "Green", value: "Green" },
    { name: "Yellow", value: "Yellow" },
    { name: "Orange", value: "Orange" },
    { name: "Pink", value: "Pink" },
    { name: "Purple", value: "Purple" },
    { name: "Maroon", value: "Maroon" },
    { name: "Olive", value: "Olive" },
  ]

  // Define categories
  const predefinedCategories = [
    { id: 'men-tees', name: "Men's Tees", page: '/men/tees' },
    { id: 'men-hoodies', name: "Men's Hoodies", page: '/men/hoodies' },
    { id: 'men-sweatshirts', name: "Men's Sweatshirts", page: '/men/sweatshirts' },
    { id: 'men-tanktops', name: "Men's Tank Tops", page: '/men/tanktops' },
    { id: 'men-shorts', name: "Men's Shorts", page: '/men/shorts' },
    { id: 'men-new-collection', name: "Men's New Collection", page: '/men/new-arrival' },
    { id: 'women-tees', name: "Women's Tees", page: '/women/tees' },
    { id: 'women-hoodies', name: "Women's Hoodies", page: '/women/hoodies' },
    { id: 'women-sweatshirts', name: "Women's Sweatshirts", page: '/women/sweatshirts' },
    { id: 'women-tanktops', name: "Women's Tank Tops", page: '/women/tanktops' },
    { id: 'women-shorts', name: "Women's Shorts", page: '/women/shorts' },
    { id: 'women-new-collection', name: "Women's New Collection", page: '/women/new-arrival' },
    { id: 'caps', name: 'Caps', page: '/accessories/cap' },
    { id: 'tote-bags', name: 'Tote Bags', page: '/accessories/tote' },
    { id: 'wallets', name: 'Wallets', page: '/accessories/wallet' }
  ]

  // Fetch product data in edit mode
  useEffect(() => {
    setCategories(predefinedCategories)
    
    if (mode === 'edit' && productId) {
      fetchProductData()
    }
  }, [mode, productId])

  const fetchProductData = async () => {
    try {
      setLoading(true)
      const token = localStorage.getItem('authToken')
      const response = await fetch(getApiUrl(`/api/products/products.php?id=${productId}`), {
        headers: {
          'Authorization': `Bearer ${token}`
        }
      })
      const data = await response.json()
      
      if (data.status === 'success' && data.data?.product) {
        const product = data.data.product
        
        // Build size quantities from variants
        const sizeQuantities = {}
        if (product.variants && product.variants.length > 0) {
          product.variants.forEach(variant => {
            if (variant.inventory && variant.inventory.length > 0) {
              variant.inventory.forEach(inv => {
                if (!sizeQuantities[inv.size]) {
                  sizeQuantities[inv.size] = 0
                }
                sizeQuantities[inv.size] += inv.quantity
              })
            }
          })
        }
        
        // Format images
        const images = []
        if (product.variants && product.variants.length > 0) {
          product.variants.forEach(variant => {
            if (variant.images && variant.images.length > 0) {
              variant.images.forEach((img, idx) => {
                images.push({
                  id: Date.now() + idx + Math.random(),
                  name: img.url.split('/').pop(),
                  url: `https://evermorebrand.com${img.url}`,
                  serverUrl: img.url
                })
              })
            }
          })
        }
        
        setFormData({
          name: product.name || "",
          category_slug: product.category_slug || "",
          description: product.description || "",
          base_price: product.base_price || "",
          color: product.variants?.[0]?.color || "",
          sizeQuantities: sizeQuantities,
          images: images.slice(0, 4), // Max 4 images
          size_fit: product.size_fit || "",
          care_maintenance: product.care_maintenance || ""
        })
      }
    } catch (err) {
      console.error('Failed to fetch product:', err)
      setError('Failed to load product data')
    } finally {
      setLoading(false)
    }
  }

  const handleInputChange = (e) => {
    const { name, value } = e.target
    setFormData((prev) => ({ ...prev, [name]: value }))
  }

  const handleSizeQuantityChange = (size, quantity) => {
    setFormData((prev) => ({
      ...prev,
      sizeQuantities: {
        ...prev.sizeQuantities,
        [size]: parseInt(quantity) || 0
      }
    }))
  }

  const handleImageUpload = async (e) => {
    const files = Array.from(e.target.files)
    
    if (files.length === 0) return
    
    if (formData.images.length + files.length > 4) {
      setError('Maximum 4 images allowed per product')
      e.target.value = ''
      return
    }
    
    setLoading(true)
    const uploadedImages = []
    
    try {
      const token = localStorage.getItem('authToken')
      
      for (const file of files) {
        if (!['image/jpeg', 'image/jpg', 'image/png', 'image/webp'].includes(file.type)) {
          setError(`Invalid file type: ${file.name}. Only JPG, PNG, and WEBP allowed.`)
          continue
        }
        
        if (file.size > 5 * 1024 * 1024) {
          setError(`File too large: ${file.name}. Maximum 5MB.`)
          continue
        }
        
        const formData = new FormData()
        formData.append('image', file)
        
        const response = await fetch(getApiUrl('/api/admin/upload_image.php'), {
          method: 'POST',
          headers: {
            'Authorization': `Bearer ${token}`
          },
          body: formData
        })
        
        const data = await response.json()
        
        if (data.status === 'success') {
          uploadedImages.push({
            id: Date.now() + Math.random(),
            name: data.data.filename,
            url: `https://evermorebrand.com${data.data.image_url}`,
            serverUrl: data.data.image_url
          })
        } else {
          setError(data.message || `Failed to upload ${file.name}`)
        }
      }
      
      setFormData((prev) => ({
        ...prev,
        images: [...prev.images, ...uploadedImages],
      }))
      
      if (uploadedImages.length > 0) {
        setSuccess(`${uploadedImages.length} image(s) uploaded successfully!`)
        setTimeout(() => setSuccess(''), 3000)
      }
      
    } catch (err) {
      console.error('Image upload error:', err)
      setError('Failed to upload images. Please try again.')
    } finally {
      setLoading(false)
      e.target.value = ''
    }
  }

  const handleRemoveImage = (imageId) => {
    setFormData((prev) => ({
      ...prev,
      images: prev.images.filter((img) => img.id !== imageId),
    }))
  }

  const handleSubmit = async () => {
    setError('')
    setSuccess('')

    // Validation
    if (!formData.name || !formData.category_slug || !formData.base_price) {
      setError('Product name, category, and price are required')
      return
    }

    if (!formData.color) {
      setError('Please select a color')
      return
    }

    if (formData.images.length === 0) {
      setError('At least one product image is required')
      return
    }

    const hasQuantity = Object.values(formData.sizeQuantities).some(q => q > 0)
    if (!hasQuantity) {
      setError('Please add at least one size with quantity')
      return
    }

    setLoading(true)

    try {
      const token = localStorage.getItem('authToken')
      const imageUrls = formData.images.map(img => img.serverUrl)
      
      const productData = {
        name: formData.name,
        category_slug: formData.category_slug,
        description: formData.description,
        base_price: parseFloat(formData.base_price),
        size_fit: formData.size_fit,
        care_maintenance: formData.care_maintenance,
        variants: [
          {
            color: formData.color,
            images: imageUrls,
            inventory: Object.entries(formData.sizeQuantities)
              .filter(([_, qty]) => qty > 0)
              .map(([size, qty]) => ({ size, quantity: qty }))
          }
        ]
      }

      const url = mode === 'edit' 
        ? getApiUrl(`/api/products/manage.php?id=${productId}`)
        : getApiUrl('/api/products/manage.php')
      
      const method = mode === 'edit' ? 'PUT' : 'POST'

      const response = await fetch(url, {
        method: method,
        headers: {
          'Content-Type': 'application/json',
          'Authorization': `Bearer ${token}`
        },
        body: JSON.stringify(productData)
      })

      const data = await response.json()

      if (data.status === 'success') {
        setSuccess(mode === 'edit' ? 'Product updated successfully!' : 'Product added successfully!')
        setTimeout(() => {
          if (onSuccess) onSuccess()
        }, 1500)
      } else {
        setError(data.message || `Failed to ${mode === 'edit' ? 'update' : 'add'} product`)
      }
    } catch (err) {
      console.error(`${mode} product error:`, err)
      setError(`Failed to ${mode === 'edit' ? 'update' : 'add'} product. Please try again.`)
    } finally {
      setLoading(false)
    }
  }

  if (loading && mode === 'edit' && !formData.name) {
    return <div style={{padding: '40px', textAlign: 'center'}}>Loading product data...</div>
  }

  return (
    <div>
      <h2 style={{marginBottom: '20px', color: '#000'}}>{mode === 'edit' ? 'MODIFY PRODUCT' : 'ADD NEW PRODUCT'}</h2>
      
      {error && <div className="alert alert-danger">{error}</div>}
      {success && <div className="alert alert-success">{success}</div>}

      <div className="form-group">
        <label>Product Name *</label>
        <input
          type="text"
          name="name"
          placeholder="e.g., T-shirt"
          value={formData.name}
          onChange={handleInputChange}
          className="form-control"
        />
      </div>

      <div className="form-group">
        <label>Category *</label>
        <select
          name="category_slug"
          value={formData.category_slug}
          onChange={handleInputChange}
          className="form-control"
        >
          <option value="">Select Category</option>
          {categories.map((cat) => (
            <option key={cat.id} value={cat.id}>
              {cat.name}
            </option>
          ))}
        </select>
      </div>

      <div className="form-group">
        <label>Color *</label>
        <select
          name="color"
          value={formData.color}
          onChange={handleInputChange}
          className="form-control"
        >
          <option value="">Select Color</option>
          {colorOptions.map((color) => (
            <option key={color.value} value={color.value}>
              {color.name}
            </option>
          ))}
        </select>
      </div>

      <div className="form-group">
        <label>Price (TK) *</label>
        <input
          type="number"
          name="base_price"
          placeholder="e.g., 780.00"
          value={formData.base_price}
          onChange={handleInputChange}
          className="form-control"
          step="0.01"
          min="0"
        />
      </div>

      <div className="form-group">
        <label>Description</label>
        <textarea
          name="description"
          placeholder="Product description..."
          value={formData.description}
          onChange={handleInputChange}
          className="form-control"
          rows="4"
        />
      </div>

      <div className="form-group">
        <label>Size & Quantity *</label>
        <div style={{display: 'grid', gridTemplateColumns: 'repeat(auto-fill, minmax(100px, 1fr))', gap: '10px'}}>
          {sizes.map((size) => (
            <div key={size}>
              <label>{size}</label>
              <input
                type="number"
                placeholder="Qty"
                value={formData.sizeQuantities[size] || ""}
                onChange={(e) => handleSizeQuantityChange(size, e.target.value)}
                min="0"
                max="1000"
              />
            </div>
          ))}
        </div>
        <small>Enter quantity for each available size. Leave 0 or empty for unavailable sizes.</small>
      </div>

      <div className="form-group">
        <label>Size & Fit</label>
        <textarea
          name="size_fit"
          placeholder="Model is wearing size Medium..."
          value={formData.size_fit}
          onChange={handleInputChange}
          className="form-control"
          rows="3"
        />
      </div>

      <div className="form-group">
        <label>Care & Maintenance</label>
        <textarea
          name="care_maintenance"
          placeholder="Machine wash cold..."
          value={formData.care_maintenance}
          onChange={handleInputChange}
          className="form-control"
          rows="3"
        />
      </div>

      <div className="form-group">
        <label>Product Images * (Upload 1-4 images)</label>
        <div style={{marginBottom: '10px'}}>
          <input
            type="file"
            id="product-images-upload"
            multiple
            accept="image/jpeg,image/jpg,image/png,image/webp"
            onChange={handleImageUpload}
            style={{display: 'none'}}
            disabled={formData.images.length >= 4 || loading}
          />
          <button
            type="button"
            onClick={() => document.getElementById('product-images-upload').click()}
            className="btn btn-secondary"
            disabled={formData.images.length >= 4 || loading}
            style={{padding: '10px 20px', cursor: 'pointer'}}
          >
            {loading ? 'Uploading...' : 'Choose Files'}
          </button>
        </div>
        <small>Supported formats: JPG, PNG, WEBP | Max size: 5MB per image | 
          {formData.images.length >= 4 ? ' Maximum reached' : ` ${4 - formData.images.length} slot(s) remaining`}
        </small>

        {formData.images.length > 0 && (
          <div className="images-preview">
            {formData.images.map((image) => (
              <div key={image.id} className="image-item">
                <img src={image.url} alt={image.name} />
                <button
                  type="button"
                  onClick={() => handleRemoveImage(image.id)}
                  className="remove-image-btn"
                >
                  Ã—
                </button>
                <p>{image.name}</p>
              </div>
            ))}
          </div>
        )}
      </div>

      <div style={{display: 'flex', gap: '10px', marginTop: '20px'}}>
        <button
          onClick={handleSubmit}
          disabled={loading}
          className="btn btn-success"
          style={{padding: '12px 30px', fontSize: '16px'}}
        >
          {loading ? 'Processing...' : (mode === 'edit' ? 'UPDATE PRODUCT' : 'PUBLISH PRODUCT')}
        </button>
        
        {onCancel && (
          <button
            onClick={onCancel}
            disabled={loading}
            className="btn btn-secondary"
            style={{padding: '12px 30px', fontSize: '16px'}}
          >
            Cancel
          </button>
        )}
      </div>
    </div>
  )
}
