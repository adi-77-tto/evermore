import React, { useState, useEffect } from "react"
import { getApiUrl } from '../../config/api'
import ProductForm from '../components/ProductForm'
import "./ManageProducts.css"

export default function ManageProducts() {
  const [products, setProducts] = useState([])
  const [viewInventoryModal, setViewInventoryModal] = useState(false)
  const [selectedProduct, setSelectedProduct] = useState(null)
  const [productInventory, setProductInventory] = useState([])
  const [editMode, setEditMode] = useState(false)
  const [editProductId, setEditProductId] = useState(null)
  const [showAddForm, setShowAddForm] = useState(false)

  const fetchProducts = async () => {
    try {
      const token = localStorage.getItem('authToken')
      const response = await fetch(getApiUrl('/api/products/manage.php'), {
        headers: {
          'Authorization': `Bearer ${token}`
        }
      })
      const data = await response.json()
      if (data.status === 'success') {
        setProducts(data.data.products)
      }
    } catch (err) {
      console.error('Failed to fetch products:', err)
    }
  }

  const handleInputChange = (e) => {
    const { name, value } = e.target
    setFormData((prev) => ({ ...prev, [name]: value }))
  }

  const handleSizeQuantityChange = (size, quantity) => {
    setFormData((prev) => ({
      ...prev,
      sizeQuantities: {
        ...prev.sizeQuantities,
        [size]: parseInt(quantity) || 0
      }
    }))
  }

  const handleImageUpload = async (e) => {
    const files = Array.from(e.target.files)
    
    if (files.length === 0) return
    
    // Check if adding these files would exceed the limit
    if (formData.images.length + files.length > 4) {
      setError('Maximum 4 images allowed per product')
      e.target.value = '' // Reset file input
      return
    }
    
    setLoading(true)
    const uploadedImages = []
    
    try {
      const token = localStorage.getItem('authToken')
      
      for (const file of files) {
        // Validate file type
        if (!['image/jpeg', 'image/jpg', 'image/png', 'image/webp'].includes(file.type)) {
          setError(`Invalid file type: ${file.name}. Only JPG, PNG, and WEBP allowed.`)
          continue
        }
        
        // Validate file size (5MB)
        if (file.size > 5 * 1024 * 1024) {
          setError(`File too large: ${file.name}. Maximum 5MB.`)
          continue
        }
        
        // Create FormData for upload
        const formData = new FormData()
        formData.append('image', file)
        
        // Upload image
        const response = await fetch(getApiUrl('/api/admin/upload_image.php'), {
          method: 'POST',
          headers: {
            'Authorization': `Bearer ${token}`
          },
          body: formData
        })
        
        const data = await response.json()
        
        if (data.status === 'success') {
          uploadedImages.push({
            id: Date.now() + Math.random(),
            name: data.data.filename,
            url: `https://evermorebrand.com${data.data.image_url}`,
            serverUrl: data.data.image_url // Store server path for saving to DB
          })
        } else {
          setError(data.message || `Failed to upload ${file.name}`)
        }
      }
      
      // Add uploaded images to form data
      setFormData((prev) => ({
        ...prev,
        images: [...prev.images, ...uploadedImages],
      }))
      
      if (uploadedImages.length > 0) {
        setSuccess(`${uploadedImages.length} image(s) uploaded successfully!`)
        setTimeout(() => setSuccess(''), 3000)
      }
      
    } catch (err) {
      console.error('Image upload error:', err)
      setError('Failed to upload images. Please try again.')
    } finally {
      setLoading(false)
      e.target.value = '' // Reset file input to allow re-selection
    }
  }

  const handleRemoveImage = (imageId) => {
    setFormData((prev) => ({
      ...prev,
      images: prev.images.filter((img) => img.id !== imageId),
    }))
  }

  const uploadImages = async (images) => {
    // Images are already uploaded, just extract server URLs
    return images.map(img => img.serverUrl)
  }

  const handleAddProduct = async () => {
    setError('')
    setSuccess('')

    // Validation
    if (!formData.name || !formData.category_slug || !formData.base_price) {
      setError('Product name, category, and price are required')
      return
    }

    const selectedSizes = Object.keys(formData.sizeQuantities).filter(
      size => formData.sizeQuantities[size] > 0
    )

    if (selectedSizes.length === 0) {
      setError('Please add at least one size with quantity')
      return
    }

    if (formData.images.length === 0) {
      setError('Please upload at least one product image')
      return
    }

    setLoading(true)

    try {
      // Upload images (in production, upload to server/cloud storage)
      const imageUrls = await uploadImages(formData.images)

      // Prepare sizes data
      const sizesData = selectedSizes.map(size => ({
        size: size,
        quantity: formData.sizeQuantities[size]
      }))

      const token = localStorage.getItem('authToken')
      const response = await fetch(getApiUrl('/api/products/manage.php'), {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': `Bearer ${token}`
        },
        body: JSON.stringify({
          name: formData.name,
          category_slug: formData.category_slug,
          description: formData.description,
          base_price: parseFloat(formData.base_price),
          color: formData.color || null,
          sizes: sizesData,
          images: imageUrls
        })
      })

      const data = await response.json()

      if (data.status === 'success') {
        setSuccess('Product added successfully!')
        setFormData({
          name: "",
          category_slug: "",
          description: "",
          base_price: "",
          color: "",
          sizeQuantities: {},
          images: []
        })
        fetchProducts() // Refresh product list
        setTimeout(() => setSuccess(''), 3000)
      } else {
        setError(data.message || 'Failed to add product')
      }
    } catch (err) {
      console.error('Error adding product:', err)
      setError('Network error. Please try again.')
    } finally {
      setLoading(false)
    }
  }

  const handleDeleteProduct = async (productId) => {
    if (!window.confirm('Are you sure you want to delete this entire product and all its variants?')) {
      return
    }

    try {
      const token = localStorage.getItem('authToken')
      const response = await fetch(
        getApiUrl(`/api/products/manage.php?product_id=${productId}`),
        {
          method: 'DELETE',
          headers: {
            'Authorization': `Bearer ${token}`
          }
        }
      )

      const data = await response.json()

      if (data.status === 'success') {
        setSuccess('Product deleted successfully!')
        fetchProducts()
        setTimeout(() => setSuccess(''), 3000)
      } else {
        setError(data.message || 'Failed to delete product')
      }
    } catch (err) {
      console.error('Error deleting product:', err)
      setError('Network error. Please try again.')
    }
  }

  const handleViewInventory = async (product) => {
    setSelectedProduct(product)
    setLoading(true)
    
    try {
      const token = localStorage.getItem('authToken')
      const response = await fetch(
        getApiUrl(`/api/products/products.php?id=${product.id}`),
        {
          headers: {
            'Authorization': `Bearer ${token}`
          }
        }
      )
      
      const data = await response.json()
      
      if (data.status === 'success' && data.data.product) {
        // Group inventory by color
        const inventoryByColor = {}
        
        data.data.product.variants.forEach(variant => {
          const color = variant.color || 'No Color'
          if (!inventoryByColor[color]) {
            inventoryByColor[color] = {
              variantId: variant.variant_id,
              color: color,
              inventory: []
            }
          }
          
          if (variant.inventory) {
            variant.inventory.forEach(inv => {
              inventoryByColor[color].inventory.push({
                size: inv.size,
                quantity: inv.quantity,
                available: inv.available
              })
            })
          }
        })
        
        setProductInventory(Object.values(inventoryByColor))
        setViewInventoryModal(true)
      } else {
        setError('Failed to load inventory')
      }
    } catch (err) {
      console.error('Error fetching inventory:', err)
      setError('Failed to load inventory')
    } finally {
      setLoading(false)
    }
  }

  const handleDeleteVariant = async (variantId, color) => {
    if (!window.confirm(`Are you sure you want to delete the ${color} variant?`)) {
      return
    }

    try {
      const token = localStorage.getItem('authToken')
      const response = await fetch(
        getApiUrl(`/api/products/manage.php?variant_id=${variantId}`),
        {
          method: 'DELETE',
          headers: {
            'Authorization': `Bearer ${token}`
          }
        }
      )

      const data = await response.json()

      if (data.status === 'success') {
        setSuccess(`${color} variant deleted successfully!`)
        // Refresh inventory view
        handleViewInventory(selectedProduct)
        fetchProducts()
        setTimeout(() => setSuccess(''), 3000)
      } else {
        setError(data.message || 'Failed to delete variant')
      }
    } catch (err) {
      console.error('Error deleting variant:', err)
      setError('Network error. Please try again.')
    }
  }

  return (
    <div className="page-container">
      <h1>Manage Products & Categories</h1>

      {error && <div className="alert alert-error">{error}</div>}
      {success && <div className="alert alert-success">{success}</div>}

      <div className="product-form">
        <h2>Add New Product</h2>

        <div className="form-row">
          <div className="form-group">
            <label>Product Name *</label>
            <input
              type="text"
              name="name"
              placeholder="e.g., Polo T-Shirt"
              value={formData.name}
              onChange={handleInputChange}
            />
            <small>If same product name exists with different color, it will be grouped together</small>
          </div>

          <div className="form-group">
            <label>Category * (Select which page to display product)</label>
            <select name="category_slug" value={formData.category_slug} onChange={handleInputChange}>
              <option value="">Select Category / Page</option>
              {categories.map((cat) => (
                <option key={cat.id} value={cat.id}>
                  {cat.name} → {cat.page}
                </option>
              ))}
            </select>
            <small>Product will appear on the selected page</small>
          </div>
        </div>

        <div className="form-row">
          <div className="form-group">
            <label>Price (BDT) *</label>
            <input
              type="number"
              name="base_price"
              placeholder="e.g., 780.00"
              value={formData.base_price}
              onChange={handleInputChange}
              min="0"
              step="0.01"
            />
          </div>

          <div className="form-group">
            <label>Color (Optional)</label>
            <select
              name="color"
              value={formData.color}
              onChange={handleInputChange}
            >
              <option value="">Select Color (Optional)</option>
              {colorOptions.map((color) => (
                <option key={color.value} value={color.value}>
                  {color.name}
                </option>
              ))}
            </select>
            <small>Leave empty if no color variant</small>
          </div>
        </div>
        <div className="form-group">
          <label>Description</label>
          <textarea
            name="description"
            placeholder="Product description..."
            value={formData.description}
            onChange={handleInputChange}
            rows="3"
          />
        </div>

        <div className="form-group">
          <label>Size & Quantity *</label>
          <div className="size-quantity-grid">
            {sizes.map((size) => (
              <div key={size} className="size-quantity-item">
                <label>{size}</label>
                <input
                  type="number"
                  placeholder="Qty"
                  value={formData.sizeQuantities[size] || ''}
                  onChange={(e) => handleSizeQuantityChange(size, e.target.value)}
                  min="0"
                  max="1000"
                />
              </div>
            ))}
          </div>
          <small>Enter quantity for each available size. Leave 0 or empty for unavailable sizes.</small>
        </div>

        <div className="form-group">
          <label>Product Images * (Upload 1-4 images)</label>
          <div style={{marginBottom: '10px'}}>
            <input 
              type="file" 
              id="product-images-upload"
              multiple 
              accept="image/jpeg,image/jpg,image/png,image/webp" 
              onChange={handleImageUpload} 
              style={{display: 'none'}}
              disabled={formData.images.length >= 4 || loading}
            />
            <button
              type="button"
              onClick={() => document.getElementById('product-images-upload').click()}
              className="btn btn-secondary"
              disabled={formData.images.length >= 4 || loading}
              style={{padding: '10px 20px', cursor: 'pointer'}}
            >
              {loading ? 'Uploading...' : 'Choose Files'}
            </button>
          </div>
          <small>
            Supported formats: JPG, PNG, WEBP | Max size: 5MB per image | 
            {formData.images.length >= 4 ? ' Maximum reached' : ` ${4 - formData.images.length} slot(s) remaining`}
          </small>
          {formData.images.length > 0 && (
            <div className="images-preview">
              {formData.images.map((img, index) => (
                <div key={img.id} className="image-item">
                  <img src={img.url} alt={img.name} />
                  {index === 0 && <span className="primary-badge">Primary</span>}
                  <button 
                    type="button" 
                    className="btn btn-danger btn-sm" 
                    onClick={() => handleRemoveImage(img.id)}
                    disabled={loading}
                  >
                    Remove
                  </button>
                </div>
              ))}
            </div>
          )}
        </div>

        <button 
          className="btn btn-primary" 
          onClick={handleAddProduct}
          disabled={loading}
        >
          {loading ? 'Adding Product...' : 'Add Product'}
        </button>
      </div>

      <div className="products-table">
        <h2>Existing Products</h2>
        {loading && <p>Loading products...</p>}
        <table>
          <thead>
            <tr>
              <th>Product Name</th>
              <th>Category</th>
              <th>Color</th>
              <th>Price</th>
              <th>Total Stock</th>
              <th>Action</th>
            </tr>
          </thead>
          <tbody>
            {products.length === 0 ? (
              <tr>
                <td colSpan="6" style={{ textAlign: "center", padding: "20px" }}>
                  No products added yet
                </td>
              </tr>
            ) : (
              products.map((p) => {
                const category = predefinedCategories.find(c => c.id === p.category_slug)
                return (
                <tr key={p.id}>
                  <td>{p.name}</td>
                  <td>{category ? category.name : p.category_slug}</td>
                  <td>
                    {p.colors && p.colors.length > 0 ? (
                      <span style={{ color: '#000' }}>{p.colors.join(', ')}</span>
                    ) : (
                      <span style={{ color: '#999' }}>No color</span>
                    )}
                  </td>
                  <td>TK {parseFloat(p.base_price).toFixed(2)} BDT</td>
                  <td>{p.total_quantity || 0}</td>
                  <td>
                    <button 
                      className="btn btn-primary btn-sm" 
                      onClick={() => handleViewInventory(p)}
                      style={{marginRight: '5px'}}
                    >
                      View
                    </button>
                    <button 
                      className="btn btn-danger btn-sm" 
                      onClick={() => handleDeleteProduct(p.id)}
                    >
                      Delete
                    </button>
                  </td>
                </tr>
              )})
            )}
          </tbody>
        </table>
      </div>

      {/* Inventory View Modal */}
      {viewInventoryModal && (
        <div className="modal-overlay" onClick={() => setViewInventoryModal(false)}>
          <div className="modal-content" onClick={(e) => e.stopPropagation()} style={{maxWidth: '800px', maxHeight: '80vh', overflow: 'auto'}}>
            <div className="modal-header">
              <h2>Inventory for {selectedProduct?.name}</h2>
              <button className="modal-close" onClick={() => setViewInventoryModal(false)}>×</button>
            </div>
            
            <div className="modal-body" style={{padding: '20px'}}>
              {productInventory.length === 0 ? (
                <p>No inventory found for this product.</p>
              ) : (
                productInventory.map((colorGroup, idx) => (
                  <div key={idx} style={{marginBottom: '30px', border: '1px solid #ddd', borderRadius: '8px', padding: '15px'}}>
                    <div style={{display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '15px'}}>
                      <h3 style={{margin: 0, color: '#000'}}>Color: {colorGroup.color}</h3>
                      <button 
                        className="btn btn-danger btn-sm"
                        onClick={() => handleDeleteVariant(colorGroup.variantId, colorGroup.color)}
                      >
                        Delete Variant
                      </button>
                    </div>
                    
                    <table style={{width: '100%', borderCollapse: 'collapse'}}>
                      <thead>
                        <tr style={{background: '#f5f5f5'}}>
                          <th style={{padding: '10px', textAlign: 'left', borderBottom: '2px solid #ddd', color: '#000'}}>Size</th>
                          <th style={{padding: '10px', textAlign: 'right', borderBottom: '2px solid #ddd', color: '#000'}}>Quantity</th>
                        </tr>
                      </thead>
                      <tbody>
                        {colorGroup.inventory.length === 0 ? (
                          <tr>
                            <td colSpan="2" style={{padding: '10px', textAlign: 'center', color: '#999'}}>No sizes available</td>
                          </tr>
                        ) : (
                          colorGroup.inventory.map((inv, invIdx) => (
                            <tr key={invIdx}>
                              <td style={{padding: '10px', borderBottom: '1px solid #eee', color: '#000'}}>{inv.size}</td>
                              <td style={{padding: '10px', textAlign: 'right', borderBottom: '1px solid #eee', color: '#000', fontWeight: 600}}>
                                {inv.quantity}
                              </td>
                            </tr>
                          ))
                        )}
                        <tr style={{background: '#f9f9f9', fontWeight: 'bold'}}>
                          <td style={{padding: '10px', color: '#000'}}>Total</td>
                          <td style={{padding: '10px', textAlign: 'right', color: '#000'}}>
                            {colorGroup.inventory.reduce((sum, inv) => sum + inv.quantity, 0)}
                          </td>
                        </tr>
                      </tbody>
                    </table>
                  </div>
                ))
              )}
              
              <div style={{marginTop: '20px', padding: '15px', background: '#f0f0f0', borderRadius: '8px'}}>
                <h3 style={{margin: '0 0 10px 0', color: '#000'}}>Total Stock Summary</h3>
                <p style={{margin: 0, fontSize: '18px', fontWeight: 'bold', color: '#000'}}>
                  Grand Total: {productInventory.reduce((total, colorGroup) => 
                    total + colorGroup.inventory.reduce((sum, inv) => sum + inv.quantity, 0), 0
                  )} units
                </p>
              </div>
            </div>
            
            <div className="modal-footer" style={{padding: '15px', borderTop: '1px solid #ddd', textAlign: 'right'}}>
              <button className="btn btn-secondary" onClick={() => setViewInventoryModal(false)}>Close</button>
            </div>
          </div>
        </div>
      )}
    </div>
  )
}
